<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üß† NOOR AI ‚Äî Kidney Disease Classifier</title>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<style>
:root {
  --bg: #020617;
  --fg: #e0e6ff;
  --card: rgba(255,255,255,0.06);
  --border: rgba(255,255,255,0.2);
  --accent1: #00b4d8;
  --accent2: #14ffec;
}

body {
  background: radial-gradient(circle at top, var(--bg), #000);
  color: var(--fg);
  font-family: 'Poppins', sans-serif;
  padding: 40px 10px;
  transition: 0.3s;
}

.glass-panel {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  backdrop-filter: blur(8px);
}

.display-img {
  width: 100%;
  max-height: 400px;
  border-radius: 12px;
  border: 1px solid var(--border);
  object-fit: contain;
}

.btn-main {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border: none;
  color: #000;
  font-weight: 600;
  padding: 12px;
  width: 100%;
  margin-top: 12px;
  border-radius: 10px;
}

.result-box {
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  padding: 20px;
  border-radius: 12px;
  min-height: 120px;
}
</style>

</head>

<body>

<h3 class="text-center fw-bold mb-4"
    style="background: linear-gradient(90deg, var(--accent2), var(--accent1));
           -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
    üß† NOOR AI ‚Äî Kidney Disease Classifier
</h3>

<div class="container">
  <div class="row justify-content-center">

    <!-- LEFT PANEL = UPLOAD -->
    <div class="col-md-5 glass-panel me-md-3">

      <h4 class="text-center mb-3">Upload / Capture</h4>

      <video id="video" autoplay width="100%" height="300"
             style="background:black; border-radius:12px;"></video>

      <img id="photo" class="display-img" style="display:none;">
      <canvas id="canvas" style="display:none;"></canvas>

      <!-- Camera Switch -->
      <button id="switchCamera" class="btn-main">üîÑ Switch Camera</button>

      <div class="mt-3">
        <button id="uploadBtn" class="btn-main">üìÅ Upload</button>
        <button id="captureBtn" class="btn-main">üì∏ Capture</button>
        <button id="predictBtn" class="btn-main">Predict üîç</button>
        <input type="file" id="fileinput" accept="image/*" style="display:none;">
      </div>

    </div>

    <!-- RIGHT PANEL = RESULTS -->
    <div class="col-md-5 glass-panel">

      <h4 class="text-center mb-3">Prediction Result</h4>

      <div class="result-box jsonRes">No prediction yet...</div>

      <button id="heatmapBtn" class="btn-main" style="display:none;">
        üî• View Heatmap
      </button>

      <button id="downloadBtn" class="btn-main" style="display:none;">
        ‚¨áÔ∏è Download Heatmap
      </button>

    </div>

  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
let base_data = "";
let last_heatmap = "";
let last_prediction = "";

let video = document.getElementById("video");
let currentFacingMode = "environment"; // BACK CAMERA

function startCamera(facingMode) {
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode }
    })
    .then(stream => { video.srcObject = stream; })
    .catch(err => console.error(err));
}

// Start with BACK camera
startCamera(currentFacingMode);

// Switch Camera Button
document.getElementById("switchCamera").addEventListener("click", () => {
    currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
    startCamera(currentFacingMode);
});

/* Upload */
$("#uploadBtn").click(() => $("#fileinput").trigger("click"));

$("#fileinput").change(function () {
    let file = this.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        $("#photo").attr("src", e.target.result).show();
        $("#video").hide();
        base_data = e.target.result.replace(/^data:image.+;base64,/, "");
    };
    reader.readAsDataURL(file);
});

/* Capture */
$("#captureBtn").click(function () {
  let canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  let data = canvas.toDataURL("image/jpeg");
  $("#photo").attr("src", data).show();
  $("#video").hide();
  base_data = data.replace(/^data:image.+;base64,/, "");
});

/* Predict */
$("#predictBtn").click(function () {
    if (!base_data) return alert("‚ö† Upload or capture an image first!");

    $(".jsonRes").html("‚è≥ Processing...");

    $.ajax({
        url: "/predict",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ image: base_data }),

        success: function (res) {
            if (res.status !== "success") {
                $(".jsonRes").html("‚ùå Error!");
                return;
            }

            let data = res.result;
            last_heatmap = data.gradcam_path;
            last_prediction = data.prediction;

            $(".jsonRes").html(`
              <b>Prediction:</b> ${data.prediction}<br>
              <b>Confidence:</b> ${data.confidence}
            `);

            $("#heatmapBtn").show();
            $("#downloadBtn").show();

            $("#heatmapBtn").click(() => window.location.href = "/heatmap");

            $("#downloadBtn").off().click(() => {
                if (last_prediction === "Normal") {
                    alert("‚ö† Heatmap is not available for Normal images");
                } else {
                    window.location.href = "/" + last_heatmap;
                }
            });
        }
    });
});
</script>

</body>
</html>
